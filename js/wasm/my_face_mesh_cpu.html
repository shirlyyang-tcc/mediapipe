<!DOCTYPE html>
<html>
    <header>
        <style>
            #container {
                display: flex;
                flex-direction: row;
                /* flex-shrink: 0.5; */
            }
        </style>
        <script src="./my_face_mesh_cpu.js"></script>
    </header>
    <body>
        <div id="container">

        </div>
        <!--play source video-->
        <video 
        id="video0"  
        muted
        loop
        crossorigin="anonymous"
        src="https://webar-static.tencent-cloud.com/temp/1.mp4"></video>
        <!--get image data from video-->
        <canvas id="proxy-canvas"></canvas>
        <!--draw facemesh result-->
        <canvas id="result-canvas"></canvas>
    </body>
    <script>
        let imgPointer
        async function initDetector() {
            return new Promise((resolve, rejct) => {
                const init = new Module()
                init.then((a) => {
                    // console.log('???', a)
                    resolve(a)
                })
                console.log('init',init)
            })

        }
        function passToWasm(uint8ArrData, Module) {
            // copying the uint8ArrData to the heap
           const numBytes = uint8ArrData.length * uint8ArrData.BYTES_PER_ELEMENT;
           const dataPtr = Module._malloc(numBytes);
           const dataOnHeap = new Uint8Array(Module.HEAPU8.buffer, dataPtr, numBytes);
           dataOnHeap.set(uint8ArrData);

           // calling the Wasm function
        //    const res = Module._myWasmFunc(dataOnHeap.byteOffset, uint8ArrData.length);
            return {
                pointer: dataOnHeap.byteOffset,
                length: uint8ArrData.length
            }
        }
        function jsOnResultCallback(list) {
            console.log('jsOnResultCallback', list)
        }
        function main(Module) {
            const video = document.querySelector('#video0')
            const proxycanvas = document.querySelector('#proxy-canvas')
            const proxycontext = proxycanvas.getContext('2d')
            let manager
            let inited
            console.log('MppGraphManager',Module.MppGraphManager)
            video.addEventListener('canplay', () => {
                const {videoWidth, videoHeight} = video
                // console.log('}}}',videoWidth, videoHeight)
                proxycanvas.style.width = videoWidth
                proxycanvas.style.height = videoHeight
                proxycanvas.width = videoWidth
                proxycanvas.height = videoHeight
              if (!inited) {
                inited = true
                if (!manager) {
                    manager = new Module.MppGraphManager(540, 960)
                    
                    console.log("manager",manager,videoWidth)
                    // manager.SetSize(videoWidth, videoHeight)
                    const result = manager.Initialize()
                    console.log('init', result)
                    // let i = manager.Test()
                    // console.log('i',i)
                }
                
                const draw = () => {
                    proxycontext.clearRect(0,0, videoWidth, videoHeight)
                    proxycontext.drawImage(video, 0, 0,videoWidth,videoHeight)
                    const imagedata = proxycontext.getImageData(0,0, videoWidth,videoHeight)

                    if(imgPointer) {
                        Module._free(imgPointer)
                    }
                    const rawDataSize = 4 * imagedata.width * imagedata.height;
                    imgPointer = Module._malloc(rawDataSize)
                    Module.HEAPU8.set(imagedata.data, imgPointer);

                    // console.log('imagedata',imagedata)
                    // manager.Send(imgPointer, rawDataSize)
                    // requestAnimationFrame(draw)

                }
                requestAnimationFrame(draw)

              }
                
            })
            video.play()
            
        }
        // setTimeout(() => {
        initDetector().then(Module => {
            console.log('+++', Module)
            main(Module)

        })
        // }, 1000)
    </script>
</html>